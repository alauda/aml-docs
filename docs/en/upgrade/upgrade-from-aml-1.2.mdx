---
weight: 10
---

# Upgrade from AML 1.2

## Install Alauda AI Essentials

Please visit [Alauda AI Essentials](../installation/ai-essentials.mdx) for installation instructions.

## Install Alauda AI Cluster Components

Please visit [Alauda AI Cluster](../installation/ai-cluster.mdx) for:

:::warning
Please ignore `Creating Alauda AI Cluster Instance` since we are upgrading from **AML** 1.2.
:::

1. [Downloading](../installation/ai-cluster.mdx#downloading) operator bundle packages for `Alauda AI Cluster` and `KServeless`.
2. [Uploading](../installation/ai-cluster.mdx#uploading) operator bundle packages to the destination cluster.
3. [Install the Alauda AI Cluster Operator](../installation/ai-cluster.mdx#install-the-alauda-ai-cluster-operator) to the destination cluster.

## Upgrading

The following procedure describes how to upgrade from **AML** `1.2` to **Alauda AI** `1.3`.

Please ensure `aml-operator` pod is up and running in`aml-operator` namespace before upgrading:

```bash
kubectl -naml-operator get pod
```

<Steps>
### Migrate Knative CRD

Due toe the breaking change of Knative CRD, you need to migrate the CRD to the new version before upgrading.

```bash
kubectl exec -it deploy/aml-operator -- /app/storageversion-migrate \
    services.serving.knative.dev \
    configurations.serving.knative.dev \
    revisions.serving.knative.dev \
    routes.serving.knative.dev \
    domainmappings.serving.knative.dev
```

Wait for the command to complete, the command output should like this:

```
INFO    storageversion/main.go:61       Migrating group resources       {"len": 5}
INFO    storageversion/main.go:64       Migrating group resource        {"resource": "services.serving.knative.dev"}
INFO    storageversion/main.go:64       Migrating group resource        {"resource": "configurations.serving.knative.dev"}
INFO    storageversion/main.go:64       Migrating group resource        {"resource": "revisions.serving.knative.dev"}
INFO    storageversion/main.go:64       Migrating group resource        {"resource": "routes.serving.knative.dev"}
INFO    storageversion/main.go:64       Migrating group resource        {"resource": "domainmappings.serving.knative.dev"}
INFO    storageversion/main.go:74       Migration complete
```

### Remove resources blocks upgrading

Some resources block upgrading so manual action is required.

Execute following command to remove problematic resources:

```bash
kubectl -nknative-serving delete pdb activator-pdb webhook-pdb
```

### Retrieve AML 1.2 Values

:::info
`helm` and `yq` utilities should be installed on the cluster node if not present.
:::

In the AML cluster, you can retrieve the values of AML 1.2 with the following `helm` command:

```bash
helm get values aml -nkubeflow -oyaml  | tee /tmp/aml-values.yaml
```

Please save the generated `/tmp/aml-values.yaml` file for later use.

### Creating GitLab Admin Token Secret

We need to create a secret for GitLab admin token, which is required to run **Alauda AI Cluster**.

Run the following command:

```bash
GITLAB_ADMIN_TOKEN=$(yq -r .global.gitToken < /tmp/aml-values.yaml)  # [!code callout]

kubectl \
  create secret generic \
  aml-gitlab-admin-token \   # [!code callout]
  --from-literal="password=${GITLAB_ADMIN_TOKEN}" \   # [!code callout]
  -n cpaas-system   # [!code callout]
```

<Callouts>

1. Retrieve the GitLab admin token from the AML 1.2 values file.
2. Create a gitlab admin token secret named **aml-gitlab-admin-token**
3. The token is saved under **password** key.
4. The secret is created under **cpaas-system** namespace.

</Callouts>

### Creating MySQL Secret

We also need to create a MySQL secret for **Alauda AI Cluster**.

Run the following command:

```bash
MYSQL_PASSWORD=$(kubectl -nkubeflow get secret mysql-secret -o jsonpath='{.data.password}' | base64 -d)

kubectl \
  create secret generic \
  aml-mysql-secret \   # [!code callout]
  --from-literal="password=${MYSQL_PASSWORD}" \   # [!code callout]
  -n cpaas-system   # [!code callout]
```

<Callouts>

1. Retrieve the MySQL password from previous AML 1.2 installed secret resource.
2. Create a MySQL admin token secret named **aml-mysql-secret**
3. The password is saved under **password** key.
4. The secret is created under **cpaas-system** namespace.

</Callouts>

### Creating Alauda AI Cluster Instance

Finally we create an `AmlCluster` resource named `default` for **Alauda AI Cluster** to finish the upgrading.

```bash
GITLAB_HOST_SCHEME=$(yq -r .global.gitScheme < /tmp/aml-values.yaml)   # [!code callout]
GITLAB_HOST_BASE=$(yq -r .global.gitBase < /tmp/aml-values.yaml)  # [!code callout]

MYSQL_HOST=$(yq -r .global.mysqlHost < /tmp/aml-values.yaml)  # [!code callout]
MYSQL_PORT=$(yq -r .global.mysqlPort < /tmp/aml-values.yaml)  # [!code callout]
MYSQL_USER=$(yq -r .global.mysqlUsername < /tmp/aml-values.yaml)  # [!code callout]

cat <<EOF | kubectl apply -f -
apiVersion: amlclusters.aml.dev/v1alpha1
kind: AmlCluster
metadata:
  name: default
spec:
  values:
    global:
      # single-node or ha-cluster
      deployFlavor: single-node
      gitlabBaseUrl: "${GITLAB_HOST_SCHEME}://${GITLAB_HOST_BASE}"
      gitlabAdminTokenSecretRef:
        # The gitlab admin token secret created previously
        name: aml-gitlab-admin-token
        namespace: cpaas-system
      mysql:
        host: "${MYSQL_HOST}"
        port: ${MYSQL_PORT}
        user: "${MYSQL_USER}"
        database: aml
        passwordSecretRef:
          # The mysql secret created previously
          name: aml-mysql-secret
          namespace: cpaas-system
    buildkitd:
      storage:
        type: emptyDir
  components:
    knativeServing:
      managementState: Managed
      ingressGateway:
        domain: "*.example.com"
        certificate:
          secretName: knative-serving-cert
          type: SelfSigned
    kserve:
      managementState: Managed
EOF

```

<Callouts>

1. Retrieve the GitLab host `scheme` (`http` or `https`) from the AML 1.2 values file.
2. Retrieve the GitLab host `base` from the AML 1.2 values file.
3. Retrieve the MySQL `host` from the AML 1.2 values file.
4. Retrieve the MySQL `port` from the AML 1.2 values file.
5. Retrieve the MySQL `user` from the AML 1.2 values file.
6. Create an `AmlCluster` resource named `default` for **Alauda AI Cluster**.

</Callouts>

</Steps>

## Verification

Check the status field from the `AMLCluster` resource which named `default`:

```bash
kubectl get amlcluster default
```

Should returns `Ready`:

```
NAME      READY   REASON
default   True    Succeeded
```
